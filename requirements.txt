Flask==3.1.2
python-dotenv==1.0.1
PyMySQL==1.1.1
gunicorn==22.0.0


let db=[];

function addService(){
  if(!serviceNo.value || !registrationDate.value) return alert("Fill fields");
  db.push({sn:serviceNo.value, rd:registrationDate.value, cd:null});
  serviceNo.value=""; registrationDate.value="";
  renderOpen(); renderHistory(); refreshDashboard();
}

function daysDiff(a,b){ return Math.floor((new Date(b)-new Date(a))/(1000*60*60*24)); }

function renderOpen(){
  let q=searchOpen.value.toLowerCase();
  let list=db.filter(x=>!x.cd && x.sn.toLowerCase().includes(q));
  openList.innerHTML=list.length? list.map(x=>{
    let i=db.indexOf(x);
    return `
      <div style="display:flex;justify-content:space-between;margin:6px 0;">
        <div>${x.sn} ‚Äî ${x.rd}</div>
        <div>
          <input type="date" id="close${i}" style="width:auto;">
          <button class="btn-small" style="background:var(--primary);color:white;" onclick="closeCall(${i})">Close</button>
        </div>
      </div>`;
  }).join(""):"No open calls";
}

function closeCall(i){
  let d=document.getElementById("close"+i).value;
  if(!d)return alert("Pick closed date");
  db[i].cd=d;
  renderOpen(); renderHistory(); refreshDashboard();
}

/* UPDATED RENDER HISTORY WITH EXACT SEARCH */
function renderHistory(){
  let q = searchHistory.value?.trim().toLowerCase() || "";

  let filtered = db.filter(x=>{
    return (
      x.sn.toLowerCase() === q ||
      x.rd.toLowerCase() === q ||
      (x.cd && x.cd.toLowerCase() === q)
    );
  });

  if(q === "") filtered = db;

  historyTable.innerHTML=`
  <table>
    <tr>
      <th>Service Number</th>
      <th>Registration Date</th>
      <th>Closed Date</th>
      <th>Status</th>
      <th>‚â§2 Days</th>
      <th>Actions</th>
    </tr>
    ${filtered.map(x=>{
      let i=db.indexOf(x);
      let st=x.cd?`<span class="status closed">Closed</span>`:`<span class="status open">Open</span>`;
      let two=x.cd?(daysDiff(x.rd,x.cd)<=2?`<span style="color:green">Yes</span>`:`<span style="color:red">No</span>`):"‚Äî";
      return `
      <tr>
        <td>${x.sn}</td>
        <td>${x.rd}</td>
        <td>${x.cd||"‚Äî"}</td>
        <td>${st}</td>
        <td>${two}</td>
        <td>
          <button class="btn-small btn-edit" onclick="editCall(${i})">‚úèÔ∏è</button>
          <button class="btn-small btn-del" onclick="delCall(${i})">üóëÔ∏è</button>
        </td>
      </tr>`;
    }).join("")}
  </table>`;
}

document.getElementById("btnSearchHistory").onclick = () => renderHistory();
document.getElementById("btnRefreshHistory").onclick = () => { searchHistory.value=""; renderHistory(); };

function editCall(i){
  let d=prompt("Closed date yyyy-mm-dd", db[i].cd||"");
  if(d==="") d=null;
  if(d && isNaN(Date.parse(d))) return alert("Invalid date");
  db[i].cd=d; renderOpen(); renderHistory(); refreshDashboard();
}

function delCall(i){
  if(confirm("Delete?")) db.splice(i,1), renderOpen(), renderHistory(), refreshDashboard();
}

function refreshDashboard(){
  let total=db.length;
  let closed2=db.filter(x=>x.cd && daysDiff(x.rd,x.cd)<=2).length;
  let perc=total?(closed2/total)*100:0;
  let score=perc>=85?5:perc<60?0:((perc-60)/(85-60))*5;
  mTotal.textContent=total;
  mClosed.textContent=closed2;
  mPerc.textContent=perc.toFixed(1)+"%";
  mScore.textContent=score.toFixed(2)+" / 5";
}

document.getElementById("tab-entry").onclick=()=>showTab("entry");
document.getElementById("tab-history").onclick=()=>showTab("history");
document.getElementById("tab-dashboard").onclick=()=>{refreshDashboard();showTab("dashboard");};

function showTab(p){
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById("tab-"+p).classList.add("active");
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById("page-"+p).style.display="block";
}

renderOpen(); renderHistory(); refreshDashboard();