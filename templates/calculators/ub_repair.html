<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UB Repair Calculator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #f8f9fa; color: #333; padding: 20px; line-height: 1.6; }
    .container { max-width: 700px; margin: 0 auto; text-align: center; }
    h1 { color: #2c3e50; margin-bottom: 10px; }
    p  { margin-bottom: 20px; color: #6c757d; }

    .calculator-card { background: white; border-radius: 15px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
    h2 { color:#2c3e50;margin-bottom:10px; }

    .input-group { margin-bottom:15px; text-align:left;}
    .input-group label { display:block;margin-bottom:5px;font-weight:bold;color:#495057; }
    .input-group input { width:100%; padding:10px; border:2px solid #e9ecef; border-radius:8px; font-size:16px; background:#f8f9fa; }
    .input-group input:focus { border-color:#2c3e50;outline:none;}

    .optional-input {opacity:.85;font-style:italic;}

    .results { background:#e9ecef; padding:15px; border-radius:8px; margin:20px 0; text-align:left;}
    .result-item { display:flex; justify-content:space-between; margin-bottom:10px;}
    #percentage,#score{font-weight:bold;font-size:18px;color:#2c3e50;}

    .buttons { display:flex; flex-wrap:wrap; gap:10px; justify-content:center;}
    .btn { padding:12px 20px; border:none; border-radius:8px; font-size:14px; font-weight:bold; cursor:pointer; transition:.3s; min-width:120px;}
    .btn:hover{transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,.2);}
    .green{background:#28a745;color:white;} .blue{background:#007bff;color:white;} .red{background:#dc3545;color:white;}

    .history-section { display:none;background:white;border-radius:15px;padding:20px;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-top:20px;}
    .history-section.active{display:block;}

    .history-table-wrapper{margin-top:15px;overflow-x:auto;}
    .history-table{width:100%;border-collapse:collapse;font-size:14px;}
    .history-table th,.history-table td{padding:8px 10px;border-bottom:1px solid #dcdfe3;text-align:left;}
    .history-table thead{background:#dee2e6;font-weight:600;color:#343a40;}

    .edit-btn,.delete-btn{padding:6px 10px;border-radius:5px;border:none;cursor:pointer;font-size:12px;color:#fff;}
    .edit-btn{background:#007bff;} .delete-btn{background:#dc3545;}

    .modal{display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);}
    .modal-content{background:white;margin:15% auto;padding:20px;border-radius:10px;width:80%;max-width:400px;text-align:left;box-shadow:0 4px 6px rgba(0,0,0,.1);}
    .close{color:#6c757d;float:right;font-size:28px;font-weight:bold;cursor:pointer;}
    .close:hover{color:#2c3e50;}
    .modal-content ul{color:#495057;list-style-position:inside;}

    @media(max-width:600px){.buttons{flex-direction:column;}.btn{width:100%;}}
  </style>
</head>
<body>
  <div class="container">
    <h1>UB Repair Calculator</h1>
    <p>Calculate your LCD repair UB efficiency</p>

    <div class="calculator-card">
      <h2>Calculator</h2>

      <div class="input-group">
        <label>Date</label>
        <input type="date" id="ubDate">
      </div>

      <div class="input-group">
        <label>Total UB Consume (optional)</label>
        <input type="number" id="iqcAttempt" min="0" placeholder="Enter UB consume value">
      </div>

      <div class="input-group">
        <label>Total LCD (optional)</label>
        <input type="number" id="totalInwarranty" min="1" placeholder="Enter total LCD">
      </div>

      <div class="input-group optional-input">
        <label>Direct Percentage</label>
        <input type="number" id="directPercentage" min="0" max="200" step="0.01"
        placeholder="Enter percentage directly (e.g. 78.50)">
      </div>

      <div class="results">
        <div class="result-item"><label>Percentage:</label><span id="percentage">0.00%</span></div>
        <div class="result-item"><label>Score:</label><span id="score">0.0 / 5</span></div>
      </div>
            <div class="buttons">
        <button class="btn green" id="calcBtn">Calculate</button>
        <button class="btn green" id="saveBtn">Save to History</button>
        <button class="btn green" id="historyBtn">View History</button>
        <button class="btn blue"  id="resetBtn">Reset</button>
        <button class="btn red"   id="infoBtn">Info</button>
      </div>
    </div>

    <div id="historySection" class="history-section">
      <h2>Calculation History</h2>
      <p>Your saved UB repair entries (editable and deletable)</p>
      <button class="btn blue" onclick="toggleHistory()">Hide History</button>
      <div id="historyList"></div>
    </div>
  </div>

  <div id="infoModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeInfo()">&times;</span>
      <h2>Scoring Information</h2>
      <ul>
        <li>â‰¥ 90% â†’ Full 5 marks</li>
        <li>â‰¤ 70% â†’ 0 marks</li>
        <li>70% - 90% â†’ Linear scaled to 5 marks</li>
        <li>Percentage = (UB Consume / Total LCD) Ã— 100</li>
      </ul>
    </div>
  </div>

  <script>
    let historyVisible = false;
    let ubEditingId = null;
    let ubEditingSource = null;

    function applyPercentage(percentage, source) {
      let score = 0;

      if (percentage >= 90) {
        score = 5;
      } else if (percentage <= 70) {
        score = 0;
      } else {
        score = ((percentage - 70) / 20) * 5;
      }

      document.getElementById('percentage').textContent = percentage.toFixed(2) + '%';
      document.getElementById('score').textContent      = score.toFixed(1) + ' / 5';

      const attempt = parseFloat(document.getElementById('iqcAttempt').value) || 0;
      const total   = parseFloat(document.getElementById('totalInwarranty').value) || 0;
      const directP = parseFloat(document.getElementById('directPercentage').value) || 0;

      window.currentCalculation = {
        percentage: percentage.toFixed(2),
        score: score.toFixed(1),
        source,
        attempt,
        total,
        directPercent: directP
      };
    }

    document.getElementById('directPercentage').addEventListener('input', function () {
      const direct = parseFloat(this.value) || 0;
      if (direct >= 0) applyPercentage(direct, 'direct');
    });

    function calculate() {
      const attempt = parseFloat(document.getElementById('iqcAttempt').value) || 0;
      const total   = parseFloat(document.getElementById('totalInwarranty').value) || 0;
      const direct  = parseFloat(document.getElementById('directPercentage').value) || 0;

      let percentage = 0;
      let source = 'direct';

      if (attempt > 0 && total > 0) {
        percentage = (attempt / total) * 100;
        source = 'formula';
      } else if (direct > 0) {
        percentage = direct;
        source = 'direct';
      } else {
        alert('Enter either UB Consume + Total LCD or Direct %');
        return;
      }

      applyPercentage(percentage, source);
    }

    async function saveToHistory() {
      const calc = window.currentCalculation;
      if (!calc) return alert('Calculate first!');

      const finalDate = document.getElementById('ubDate').value || new Date().toISOString().slice(0,10);

      const payload = {
        date: finalDate,
        source: calc.source,
        ubConsume: calc.attempt,
        totalLCD: calc.total,
        directPercent: calc.directPercent,
        percentage: calc.percentage,
        score: calc.score
      };

      const id = ubEditingId;
      let res;
      try {
        if (id) {
          res = await fetch(`/ub-repair/edit/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          });
          alert('Entry updated!');
        } else {
          res = await fetch('/ub-repair/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          });
          alert('Saved!');
        }

        const data = await res.json();
        if (!data.status === 'ok') alert('DB error');

        ubEditingId = null;
        document.getElementById('saveBtn').textContent = 'Save to History';
        if (historyVisible) loadHistory();
      } catch (err) {
        console.error(err);
        alert('Network error');
      }
    }

    async function fetchHistoryFromServer() {
      try {
        const res = await fetch('/ub-repair/history');
        const data = await res.json();
        return data.items || [];
      } catch {
        return [];
      }
    }

    async function startEdit(id) {
      const items = await fetchHistoryFromServer();
      const rec = items.find(x => String(x.id) === String(id));
      if (!rec) return;

      document.getElementById('ubDate').value          = rec.record_date || '';
      document.getElementById('iqcAttempt').value      = rec.ub_consume || '';
      document.getElementById('totalInwarranty').value = rec.total_lcd || '';
      document.getElementById('directPercentage').value= rec.direct_percent || '';

      applyPercentage(parseFloat(rec.percentage), rec.source);

      // ðŸ”¥ Fix added:
      window.currentCalculation = {
        percentage: rec.percentage,
        score: rec.score,
        source: rec.source,
        attempt: rec.ub_consume,
        total: rec.total_lcd,
        directPercent: rec.direct_percent
      };

      ubEditingId = id;
      document.getElementById('saveBtn').textContent = 'Update Entry';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }


    async function deleteEntry(id) {
      if (!confirm('Delete this entry?')) return;
      await fetch(`/ub-repair/delete/${id}`, {method:'DELETE'});
      loadHistory();
    }

    async function loadHistory() {
      const list = document.getElementById('historyList');
      const items = await fetchHistoryFromServer();

      if (!items.length) {
        list.innerHTML = '<p style="text-align:center;color:#666;">No history yet.</p>';
        return;
      }

      list.innerHTML = `
        <div class="history-table-wrapper">
        <table class="history-table">
        <thead>
        <tr><th>Date</th><th>Source</th><th>UB</th><th>LCD</th><th>Direct%</th><th>%</th><th>Score/5</th><th>Actions</th></tr>
        </thead><tbody>
        ${items.map(r=>`
        <tr>
          <td>${r.record_date}</td>
          <td>${r.source}</td>
          <td>${r.ub_consume || '-'}</td>
          <td>${r.total_lcd || '-'}</td>
          <td>${r.direct_percent || '-'}</td>
          <td>${r.percentage}</td>
          <td>${r.score}</td>
          <td>
            <button class="edit-btn" onclick="startEdit(${r.id})">Edit</button>
            <button class="delete-btn" onclick="deleteEntry(${r.id})">Delete</button>
          </td>
        </tr>`).join('')}
        </tbody></table></div>`;
    }

    function toggleHistory() {
      historyVisible = !historyVisible;
      document.getElementById('historySection').classList.toggle('active', historyVisible);
      document.getElementById('historyBtn').textContent = historyVisible ? 'Hide History' : 'View History';
      if (historyVisible) loadHistory();
    }

    function resetForm() {
      document.getElementById('ubDate').value='';
      document.getElementById('iqcAttempt').value='';
      document.getElementById('totalInwarranty').value='';
      document.getElementById('directPercentage').value='';
      document.getElementById('percentage').textContent='0.00%';
      document.getElementById('score').textContent='0.0 / 5';
      window.currentCalculation=null;
      ubEditingId=null;
      document.getElementById('saveBtn').textContent='Save to History';
    }

    function showInfo(){ document.getElementById('infoModal').style.display='block'; }
    function closeInfo(){ document.getElementById('infoModal').style.display='none'; }

    window.onclick = e => { if(e.target===infoModal) closeInfo(); };

    document.getElementById('calcBtn').onclick=calculate;
    document.getElementById('saveBtn').onclick=saveToHistory;
    document.getElementById('historyBtn').onclick=toggleHistory;
    document.getElementById('resetBtn').onclick=resetForm;
    document.getElementById('infoBtn').onclick=showInfo;

    window.startEdit=startEdit;
    window.deleteEntry=deleteEntry;
    window.toggleHistory=toggleHistory;
    window.closeInfo=closeInfo;
  </script>
</body>
</html>
