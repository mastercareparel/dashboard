<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OFS Scoring</title>
<style>
body { font-family: Arial, sans-serif; background:#f7f2ff; padding:28px; }
.card { max-width:900px; margin:auto; background:white; padding:28px; border-radius:18px; box-shadow:0 8px 22px rgba(0,0,0,0.08); }
h1 { text-align:center; color:#7b3fe4; margin-bottom:4px; }
.subtitle { text-align:center; color:#666; margin-bottom:20px; font-size:14px; }
table { width:100%; border-collapse:collapse; margin-bottom: 14px;}
th,td { padding:10px 8px; text-align:center; font-size:13px; }
th { color:#555;font-weight:600;}
input[type="number"],input[type="date"]{width:90%;padding:7px;border-radius:8px;border:1px solid #ccc;font-size:13px;}
.result{ font-weight:600; color:#7b3fe4; }
.summary{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap;}
.summary-box{flex:1;min-width:200px;background:#f4ecff;padding:16px;border-radius:12px;text-align:center;}
.value{font-size:22px;font-weight:700;color:#7b3fe4;}
.btn-row{display:flex;justify-content:flex-end;gap:10px;margin-top:16px;}
.btn{padding:8px 16px;border-radius:999px;color:white;border:none;font-weight:600;font-size:13px;cursor:pointer;}
.btn-primary{background:#7b3fe4;}
.btn-secondary{background:#6366f1;}
.btn-gray{background:#6b7280;}

/* history */
#historyPage{display:none;}
.history-title{text-align:center;font-size:22px;color:#7b3fe4;margin-bottom:10px;}
.search-input{padding:6px;border:1px solid #ccc;border-radius:8px;width:200px;}
.tag{font-weight:bold;font-size:12px;padding:4px 8px;border-radius:8px;display:inline-block;}
.tag.ok{color:#16a34a;}
.tag.avg{color:#eab308;}
.tag.low{color:#dc2626;}
.tag.bad{color:#7f1d1d;}
.action-btn{cursor:pointer;font-size:12px;color:#2563eb;font-weight:600;}
.action-del{color:#dc2626;}
</style>
</head>

<body>

<div id="calcPage" class="card">
<h1>OFS Score</h1>
<div class="subtitle">Minimal Stock Level Evaluator</div>

<label>Date:</label>
<input type="date" id="ofsDate" style="margin-bottom:12px;">

<table>
<tr>
<th>Category</th><th>Total</th><th>Ordered</th><th>%</th><th>Score</th>
</tr>
<tr>
<td>Line Items</td>
<td><input type="number" id="line_total" min="0" oninput="recalc()"></td>
<td><input type="number" id="line_ordered" min="0" oninput="recalc()"></td>
<td class="result" id="line_percent">0%</td>
<td class="result" id="line_score">0.00 / 7.5</td>
</tr>
<tr>
<td>Qty Items</td>
<td><input type="number" id="qty_total" min="0" oninput="recalc()"></td>
<td><input type="number" id="qty_ordered" min="0" oninput="recalc()"></td>
<td class="result" id="qty_percent">0%</td>
<td class="result" id="qty_score">0.00 / 7.5</td>
</tr>
</table>

<div class="summary">
<div class="summary-box"><div>Final Score</div><div class="value" id="final_score">0.00 / 15</div></div>
<div class="summary-box"><div>Status</div><div class="value" id="status_label">-</div></div>
</div>

<div class="btn-row">
<button class="btn btn-gray" onclick="showHistory()">History</button>
<button class="btn btn-secondary" onclick="resetForm()">Reset</button>
<button id="saveBtn" class="btn btn-primary" onclick="saveOrUpdate()">Save</button>
</div>
</div>

<!-- HISTORY PAGE -->
<div id="historyPage" class="card">
<div class="history-title">OFS History</div>
<div style="display:flex;gap:10px;margin-bottom:10px;">
<button class="btn btn-gray" onclick="showCalc()">‚Üê Back</button>
<input type="text" id="searchInput" class="search-input" placeholder="Search date...">
</div>
<table>
<thead>
<tr>
<th>Date</th><th>L Total</th><th>L Ord</th><th>L%</th><th>L Score</th>
<th>Q Total</th><th>Q Ord</th><th>Q%</th><th>Q Score</th>
<th>Final</th><th>Status</th><th>Edit</th><th>Delete</th>
</tr>
</thead>
<tbody id="historyBody"><tr><td colspan="13">Loading...</td></tr></tbody>
</table>
</div>

<script>
let editId=null;

function calcP(t,o){return(t>0?o/t*100:0);}
function calcS(p){return p>=80?7.5:(p<=60?0:((p-60)/20)*7.5); }

function recalc(){
let lt=+line_total.value||0, lo=+line_ordered.value||0;
let qt=+qty_total.value||0, qo=+qty_ordered.value||0;
let lp=calcP(lt,lo), qp=calcP(qt,qo);
let ls=calcS(lp), qs=calcS(qp);
let fin=ls+qs;

line_percent.textContent=lp.toFixed(1)+"%";
qty_percent.textContent=qp.toFixed(1)+"%";
line_score.textContent=ls.toFixed(2)+" / 7.5";
qty_score.textContent=qs.toFixed(2)+" / 7.5";
final_score.textContent=fin.toFixed(2)+" / 15";

let st="BELOW LIMIT";
if(fin>=10) st="WITHIN LIMIT";
else if(fin>=5) st="AVERAGE";
else if(fin>0) st="LOW";
status_label.textContent=st;
}

function resetForm(){
editId=null;
saveBtn.textContent="Save";
["line_total","line_ordered","qty_total","qty_ordered","ofsDate"]
.forEach(id=>document.getElementById(id).value="");
recalc();
}

function showCalc(){historyPage.style.display="none";calcPage.style.display="block";}
function showHistory(){loadHistory();calcPage.style.display="none";historyPage.style.display="block";}

function formatDate(d){
const dt=new Date(d);
return dt.toLocaleDateString("en-GB");
}

function saveOrUpdate(){
let payload={
date:ofsDate.value,
line_total:+line_total.value||0,
line_ordered:+line_ordered.value||0,
qty_total:+qty_total.value||0,
qty_ordered:+qty_ordered.value||0,
line_percent:parseFloat(line_percent.textContent),
qty_percent:parseFloat(qty_percent.textContent),
line_score:parseFloat(line_score.textContent),
qty_score:parseFloat(qty_score.textContent),
final_score:parseFloat(final_score.textContent),
status:status_label.textContent
};

if(editId){
fetch(`/ofs/edit_v2/${editId}`,{
method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})
.then(()=>{resetForm();showHistory();});
} else {
fetch("/ofs/save_v2",{
method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})
.then(()=>{resetForm();showHistory();});
}
}

function loadHistory(){
fetch("/ofs/history_v2").then(r=>r.json()).then(d=>{
let tb=historyBody;tb.innerHTML="";
d.items.forEach(row=>{
let tagClass=row.status=="WITHIN LIMIT"?"ok":row.status=="AVERAGE"?"avg":row.status=="LOW"?"low":"bad";
tb.innerHTML+=`
<tr>
<td>${formatDate(row.calc_date)}</td>
<td>${row.line_total}</td><td>${row.line_ordered}</td><td>${row.line_percent}%</td><td>${row.line_score}</td>
<td>${row.qty_total}</td><td>${row.qty_ordered}</td><td>${row.qty_percent}%</td><td>${row.qty_score}</td>
<td>${row.final_score}</td>
<td><span class="tag ${tagClass}">${row.status}</span></td>
<td><span class="action-btn" onclick="editRow(${row.id},'${row.calc_date}',${row.line_total},${row.line_ordered},${row.qty_total},${row.qty_ordered})">Edit</span></td>
<td><span class="action-del" onclick="delRow(${row.id})">Delete</span></td>
</tr>`;
});
});
}

function editRow(id,dt,lt,lo,qt,qo){
editId=id;
saveBtn.textContent="Update";
showCalc();
ofsDate.value=new Date(dt).toISOString().split("T")[0];
line_total.value=lt;
line_ordered.value=lo;
qty_total.value=qt;
qty_ordered.value=qo;
recalc();
}

function delRow(id){
fetch(`/ofs/delete/${id}`,{method:"DELETE"}).then(()=>loadHistory());
}
</script>
</body>
</html>
