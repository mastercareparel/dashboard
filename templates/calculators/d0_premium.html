<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>D+0 SPEED (Premium) — Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f5f4ff; --card:#fff; --accent:#6b57ff; --muted:#7a6ea3;
    }
    body{
      margin:0; font-family:"Poppins",sans-serif; background:var(--bg); color:#232034;
      padding:28px;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:980px;margin:0 auto;}
    h1{margin:6px 0 0;font-size:28px;color:#2b1d52;font-weight:700}
    p.lead{margin:6px 0 18px;color:var(--muted);}
    .card{background:var(--card);border-radius:14px;padding:20px;box-shadow:0 8px 30px rgba(56,40,120,0.06);}
    .section-title{font-weight:700;color:#2b1d52;margin-bottom:12px;font-size:16px;}
    label{display:block;font-size:13px;color:#52477a;margin-bottom:6px;}
    input[type=number],input[type=date]{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e0ff;font-size:15px;}
    .btn{display:inline-block;padding:10px 16px;border-radius:10px;border:0;color:#fff;background:var(--accent);cursor:pointer;font-weight:700;}
    .btn.secondary{background:#ff6b6b;}
    .small-btn{padding:6px 10px;border-radius:8px;border:0;font-weight:600;cursor:pointer;}
    .save{background:#2ea44f;color:white;}
    .edit{background:#007bff;color:white;}
    .delete{background:#d64545;color:white;}
    .results{background:#fbfaff;padding:12px;border-radius:10px;border:1px solid #efe9ff;margin-top:14px;}
    .big{font-size:20px;color:var(--accent);font-weight:700;}
    table{width:100%;border-collapse:collapse;margin-top:12px;}
    th,td{padding:8px 10px;border-bottom:1px solid #f0ebff;text-align:left;font-size:13px;}
    .muted{color:#8c84a8;font-size:13px;}
    .actions{display:flex;gap:8px;justify-content:center;}
    .records-card {height: 500px; display: flex; flex-direction: column; overflow: hidden;}
    .records-card #recordsTable {flex: 1; overflow-y: auto; max-height: 400px; margin-top: 0; border: 1px solid #e6e0ff; display: block;}
    .records-card thead {display: table; width: 100%; table-layout: fixed;}
    .records-card tbody {display: block; overflow-y: auto; max-height: 320px; min-height: 100px;}
    .records-card tr {display: table; width: 100%; table-layout: fixed;}
    .records-card th:nth-child(1), .records-card td:nth-child(1) { width: 25%; }
    .records-card th:nth-child(2), .records-card td:nth-child(2) { width: 15%; }
    .records-card th:nth-child(3), .records-card td:nth-child(3) { width: 20%; }
    .records-card th:nth-child(4), .records-card td:nth-child(4) { width: 15%; }
    .records-card th:nth-child(5), .records-card td:nth-child(5) { width: 25%; }
    @media (max-width:900px){
      .wrap{padding:14px;}
    }
    @media (max-width: 900px) {
      .records-card {height: 450px;}
      .records-card #recordsTable {max-height: 350px;}
      .records-card tbody {max-height: 280px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>D+0 SPEED (Premium)</h1>
    <p class="lead">Enter totals and get Actual Call, % D+0 and D+0 Score instantly</p>

    <div id="calculatorPage" style="display:block;">
      <div class="card">
        <div class="section-title">Input</div>
        <form id="d0Form" onsubmit="return false;">

          <!-- NEW: Date -->
          <div style="margin-bottom:12px">
            <label>Date</label>
            <input id="recordDate" type="date" required>
          </div>

          <div style="margin-bottom:12px">
            <label>Total Calls</label>
            <input id="totalCall" type="number" min="0" step="1" value="0" required>
          </div>
          <div style="margin-bottom:12px">
            <label>Cancel Calls</label>
            <input id="cancelCall" type="number" min="0" step="1" value="0" required>
          </div>
          <div style="margin-bottom:12px">
            <label>Good Delivered Calls</label>
            <input id="goodDelivered" type="number" min="0" step="1" value="0" required>
          </div>
          <div style="margin-bottom:12px">
            <label>Pending Calls</label>
            <input id="pendingCall" type="number" min="0" step="1" value="0" required>
          </div>

          <!-- NEW: Direct % D+0 -->
          <div style="margin-bottom:12px">
            <label>Direct % D+0 (optional)</label>
            <input id="directPercent" type="number" min="0" max="100" step="0.01"
                   placeholder="Enter % D+0 directly, e.g. 88.50">
          </div>

          <div style="display:flex;gap:10px;margin-top:10px">
            <button type="button" class="btn" id="calcBtn">Calculate</button>
            <button type="button" class="btn secondary" id="resetBtn">Reset</button>
            <div style="flex:1"></div>
            <button type="button" class="small-btn save" id="saveBtn">Save Record</button>
          </div>
        </form>
        <div class="results" id="resultsBox" style="display:none">
          <div><span class="muted">Actual Call</span><div class="big" id="actualCall">0</div></div>
          <div style="margin-top:8px"><span class="muted">Percentage of D+0</span><div class="big" id="percentD0">0%</div></div>
          <div style="margin-top:8px"><span class="muted">D+0 Score</span><div class="big" id="d0Score">0</div></div>
        </div>
        <div style="margin-top:18px;">
          <button type="button" class="btn" id="viewRecordsBtn">View Saved Records</button>
        </div>
      </div>
    </div>

    <div id="recordsPage" style="display:none;">
      <div class="card records-card">
        <div class="section-title">Saved Records</div>
        <div class="muted">Records are saved locally in your browser (localStorage).</div>
        <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center;flex-wrap:wrap;">
          <button type="button" class="btn" id="refreshBtn">Refresh</button>
          <input type="text" id="searchInput" placeholder="Search Date/Actual..." style="padding:8px 12px;border-radius:8px;border:1px solid #e6e0ff;font-size:14px;">
          <select id="scoreFilter" style="padding:8px 12px;border-radius:8px;border:1px solid #e6e0ff;font-size:14px;">
            <option value="">All Scores</option>
            <option value="0">Score = 0</option>
            <option value="1">Score = 1</option>
            <option value="2">Score = 2</option>
            <option value="3">Score = 3</option>
            <option value="4">Score = 4</option>
            <option value="5">Score = 5</option>
            <option value="6">Score = 6</option>
            <option value="7">Score = 7</option>
            <option value="8">Score = 8</option>
            <option value="9">Score = 9</option>
            <option value="10">Score = 10</option>
            <option value="gt0">Score > 0</option>
          </select>
        </div>
        <table id="recordsTable">
          <thead>
            <tr><th>Date</th><th>Actual</th><th>% D+0</th><th>Score</th><th>Actions</th></tr>
          </thead>
          <tbody id="recordsBody"></tbody>
        </table>
        <div style="margin-top:18px;">
          <button type="button" class="btn" id="backToCalcBtn">Back to Calculator</button>
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const showCalculatorPage = function () {
    document.getElementById('calculatorPage').style.display = 'block';
    document.getElementById('recordsPage').style.display = 'none';
  };

  const showRecordsPage = function () {
    document.getElementById('calculatorPage').style.display = 'none';
    document.getElementById('recordsPage').style.display = 'block';
    fetchAndRenderRecords();
  };

  let editingId = null;  // current DB row id while editing
  let filterText = "";
  let filterScore = "";

  function toNumberSafe(v) {
    const n = Number(v);
    if (!isFinite(n) || isNaN(n)) return 0;
    return Math.max(0, Math.floor(n));
  }

  // ------- CALCULATION -------

  function calculateAll() {
    const total      = toNumberSafe(document.getElementById('totalCall').value);
    const cancel     = toNumberSafe(document.getElementById('cancelCall').value);
    const delivered  = toNumberSafe(document.getElementById('goodDelivered').value);
    const pending    = toNumberSafe(document.getElementById('pendingCall').value);
    const directP    = Number(document.getElementById('directPercent').value || 0);
    const dateInput  = document.getElementById('recordDate').value;

    const actual = Math.max(0, total - cancel);

    let percentage = 0;
    if (directP > 0) {
      percentage = directP;
    } else if (actual > 0) {
      percentage = (delivered / actual) * 100;
    }

    let score = 0;
    // Premium weight 10 marks
    if (percentage >= 75) {
      score = 10;
    } else if (percentage <= 65) {
      score = 0;
    } else {
      score = 10 * ((percentage - 65) / 10);
    }

    const percentRounded = Math.round(percentage * 100) / 100;
    const scoreRounded   = Math.round(score * 100) / 100;

    document.getElementById('actualCall').textContent = actual;
    document.getElementById('percentD0').textContent  = percentRounded.toFixed(2) + '%';
    document.getElementById('d0Score').textContent    = scoreRounded.toFixed(2);

    document.getElementById('resultsBox').style.display = 'block';

    const finalDate = dateInput || new Date().toISOString().slice(0, 10);

    return {
      date: finalDate,
      actual,
      percentage: percentRounded,
      score: scoreRounded
    };
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;');
  }

  function displayDate(value) {
    if (!value) return '';
    const s = String(value);
    return s.replace(' 00:00:00 GMT', '');
  }


  // ------- SERVER CALLS -------

  async function saveRecordToServer(payload, isEdit) {
      try {
        const url    = isEdit ? `/d0-premium/edit/${editingId}` : '/d0-premium/save';
        const method = isEdit ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            date: payload.date,          // <<< ADD THIS LINE
            actual: payload.actual,
            percentage: payload.percentage,
            score: payload.score
          })
        });

        const data = await res.json();
        if (!res.ok || data.status !== 'ok') {
          alert('Server error: ' + (data.message || 'Unknown error'));
          return false;
        }
        return true;
      } catch (err) {
        console.error(err);
        alert('Network error while saving.');
        return false;
      }
    }


  async function fetchRecordsFromServer() {
    try {
      const res = await fetch('/d0-premium/history');
      const data = await res.json();
      if (!res.ok || data.status !== 'ok') {
        console.error(data);
        return [];
      }
      // items = [{id, record_date, actual, percent_d0, score}, ...]
      return data.items || [];
    } catch (err) {
      console.error(err);
      return [];
    }
  }

  async function deleteRecordFromServer(id) {
    try {
      const res = await fetch(`/d0-premium/delete/${id}`, { method: 'DELETE' });
      const data = await res.json();
      if (!res.ok || data.status !== 'ok') {
        alert('Delete failed: ' + (data.message || 'Unknown error'));
        return false;
      }
      return true;
    } catch (err) {
      console.error(err);
      alert('Network error while deleting.');
      return false;
    }
  }

  // ------- EDIT / DELETE -------

  async function handleEditClick(id, row) {
    // row = object from history API
    document.getElementById('recordDate').value    = row.record_date || '';
    document.getElementById('totalCall').value     = '';   // not stored; optional
    document.getElementById('cancelCall').value    = '';
    document.getElementById('goodDelivered').value = '';
    document.getElementById('pendingCall').value   = '';
    document.getElementById('directPercent').value = row.percent_d0 || '';

    calculateAll();
    editingId = id;
    document.getElementById('saveBtn').textContent = 'Update Record';
    showCalculatorPage();
  }

  async function handleDeleteClick(id) {
    if (!confirm('Are you sure you want to delete this record? This cannot be undone.')) return;
    const ok = await deleteRecordFromServer(id);
    if (ok) {
      alert('Record deleted successfully.');
      fetchAndRenderRecords();
    }
  }

  // ------- RENDER HISTORY -------

  async function fetchAndRenderRecords() {
    const body = document.getElementById('recordsBody');
    let records = await fetchRecordsFromServer();

    // filters
    if (filterText) {
      const t = filterText.toLowerCase();
      records = records.filter(r =>
        (r.record_date || '').toLowerCase().includes(t) ||
        String(r.actual).includes(t) ||
        String(r.score).includes(t)
      );
    }

    if (filterScore === "0") {
      records = records.filter(r => Number(r.score) === 0);
    } else if (["1","2","3","4","5","6","7","8","9","10"].includes(filterScore)) {
      records = records.filter(r => Number(r.score) === Number(filterScore));
    } else if (filterScore === "gt0") {
      records = records.filter(r => Number(r.score) > 0);
    }

    if (!records.length) {
      body.innerHTML = '<tr><td colspan="5" class="muted">No saved records yet.</td></tr>';
      return;
    }

    body.innerHTML = records.map(r => `
      <tr>
        <td>${escapeHtml(displayDate(r.record_date || ''))}</td>

        <td>${r.actual}</td>
        <td>${Number(r.percent_d0).toFixed(2)}%</td>
        <td>${Number(r.score).toFixed(2)}</td>
        <td class="actions">
          <button type="button" class="small-btn edit"
                  data-id="${r.id}">Edit</button>
          <button type="button" class="small-btn delete"
                  data-id="${r.id}">Delete</button>
        </td>
      </tr>
    `).join('');

    // attach click handlers after rendering
    body.querySelectorAll('button.edit').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        const row = records.find(r => String(r.id) === String(id));
        if (row) handleEditClick(id, row);
      });
    });
    body.querySelectorAll('button.delete').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        handleDeleteClick(id);
      });
    });
  }

  // ------- BUTTON EVENTS -------

  document.getElementById('calcBtn').addEventListener('click', function (e) {
    e.preventDefault();
    calculateAll();
  });

  document.getElementById('resetBtn').addEventListener('click', function () {
    document.getElementById('d0Form').reset();
    document.getElementById('resultsBox').style.display = 'none';
    if (editingId !== null) {
      editingId = null;
      document.getElementById('saveBtn').textContent = 'Save Record';
    }
  });

  document.getElementById('saveBtn').addEventListener('click', async function () {
    const obj = calculateAll();
    const ok = await saveRecordToServer(obj, editingId !== null);
    if (ok) {
      if (editingId !== null) {
        alert('Record updated successfully ✔');
      } else {
        alert('Record saved successfully ✔');
      }
      editingId = null;
      document.getElementById('saveBtn').textContent = 'Save Record';
      fetchAndRenderRecords();
    }
  });

  document.getElementById('viewRecordsBtn').addEventListener('click', function () {
    showRecordsPage();
  });

  document.getElementById('backToCalcBtn').addEventListener('click', function () {
    showCalculatorPage();
  });

  document.getElementById('searchInput').addEventListener('input', function (e) {
    filterText = e.target.value.trim();
    fetchAndRenderRecords();
  });

  document.getElementById('scoreFilter').addEventListener('change', function (e) {
    filterScore = e.target.value;
    fetchAndRenderRecords();
  });

  document.getElementById('refreshBtn').addEventListener('click', function () {
    filterText = "";
    filterScore = "";
    document.getElementById('searchInput').value = "";
    document.getElementById('scoreFilter').value = "";
    fetchAndRenderRecords();
  });

  // initial
  showCalculatorPage();
});
</script>

</body>
</html>
